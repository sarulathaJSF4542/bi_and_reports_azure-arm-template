<!DOCTYPE html>
@{
    var globalAppSettings = _globalAppSettings;
    var tenantAppConfig = new TenantAppConfiguration(globalAppSettings);
    var isMobile = new DeviceDetection(Context).IsMobile;
    Layout = null;
    ViewBag.Title = ViewBag.ItemName + " - [[[View Widget]]] -" + globalAppSettings.SystemSettings.OrganizationName;
    var baseUrl = ViewBag.BaseUrl;
    var dashboardServiceResourceUrl = globalAppSettings.SystemSettings.InternalAppDataServiceUrl;
    var isDebug = globalAppSettings.SystemSettings.IsDebug;
    var enableComment = "false";
    ItemDetail itemDetail = ViewBag.itemDetail;
    var isUserAuthenticated = "false";
    var isPublic = globalAppSettings.SystemSettings.IsMarkItemsPublic && itemDetail.IsPublic ? "true" : "false";
    ViewBag.DateFormat = globalAppSettings.SystemSettings.DateFormat;
    ViewBag.TimeFormat = globalAppSettings.SystemSettings.TimeFormat ? "HH:mm" : "hh:mm tt";
    var accessToken = ViewBag.accessToken;
    var faviconLogo = globalAppSettings.SystemSettings.FavIcon;
    var loginImage = globalAppSettings.SystemSettings.LoginLogo;
    var dashboardServerResourceUrl = globalAppSettings.SystemSettings.CDNLink.TrimEnd('/');
}

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    @await Html.PartialAsync("_OGPContent", new ViewDataDictionary(ViewData) { { "PageTitle", ViewBag.Title }, { "OrganizationName", globalAppSettings.SystemSettings.OrganizationName }, { "Logo", loginImage } })

    <link rel="icon" href="@faviconLogo" onerror="if (this.href != '@globalAppSettings.SystemSettings.CDNLink/images/application/@ServerAppConfig.AppSettings.AppBranding.Identifier/@IconFileNames.Favicon') this.href = '@globalAppSettings.SystemSettings.CDNLink/images/application/@ServerAppConfig.AppSettings.AppBranding.Identifier/@IconFileNames.Favicon';" />

    <title>@ViewBag.Title</title>
    @if (isDebug)
    {
        <link rel="stylesheet" type="text/css" href="@(dashboardServiceResourceUrl + "/themes/default-theme/ej.dashboardviewer.all.min.css")" />
    }
    <environment include="Development,CloudDevelopment">
        <link rel="stylesheet" asp-append-version="true" href="@dashboardServerResourceUrl/cdn/css/viewer/themes/default-theme/ej.dashboardviewer.all.css" />
    </environment>
    <environment exclude="Development,CloudDevelopment">
        <link rel="stylesheet" asp-append-version="true" href="@dashboardServerResourceUrl/cdn/css/viewer/themes/default-theme/ej.dashboardviewer.all.min.css" />
    </environment>

    @if (isMobile)
    {
        <environment include="Development,CloudDevelopment">
            <link rel="stylesheet" asp-append-version="true" href="@dashboardServerResourceUrl/cdn/css/file-render-dashboard-mobile.css" />
            <script asp-append-version="true" src="@dashboardServerResourceUrl/cdn/scripts/viewer/widget-render-mobile.js"></script>
        </environment>
        <environment exclude="Development,CloudDevelopment">
            <link rel="stylesheet" asp-append-version="true" href="@dashboardServerResourceUrl/cdn/css/file-render-dashboard-mobile.min.css" />
            <script asp-append-version="true" src="@dashboardServerResourceUrl/cdn/scripts/viewer/widget-render-mobile.min.js"></script>
        </environment>

    }
    else
    {
        <environment include="Development,CloudDevelopment">
            <link rel="stylesheet" asp-append-version="true" href="@dashboardServerResourceUrl/cdn/css/file-render-dashboard.css" />
            <script asp-append-version="true" src="@dashboardServerResourceUrl/cdn/scripts/viewer/widget-render.js"></script>
        </environment>
        <environment exclude="Development,CloudDevelopment">
            <link rel="stylesheet" asp-append-version="true" href="@dashboardServerResourceUrl/cdn/css/file-render-dashboard.min.css" />
            <script asp-append-version="true" src="@dashboardServerResourceUrl/cdn/scripts/viewer/widget-render.min.js"></script>
        </environment>

    }
    <style>
        html {
            height: 100%;
        }

        #widget_WaitingPopup {
            height: 100% !important;
            width: 100% !important;
            background-color: #fff !important;
        }
    </style>

    @await Html.PartialAsync("~/Views/Shared/_LoaderIcon.cshtml")

    <script>
        var pinWidgetToHomepageUrl = "@Url.Action("PinWidgetToHomepage", "Boards")";
        window.destroyAll = function () { try { ej.widget.destroyAll($('.e-js').off()); } catch (e) { } $(document.body).html('-'); CollectGarbage(); };
        function loadPopup(){
            var widgetWaitingPopupTemplateId = createLoader("widget");
			$("#widget").ejWaitingPopup({ template:$("#" + widgetWaitingPopupTemplateId) });
            $("#widget").ejWaitingPopup("show");
            window.location.href = window.location.href.replace(window.location.pathname + window.location.search, "");
        }
    </script>
    @if (isDebug)
    {
        <script asp-append-version="true" src="@(dashboardServiceResourceUrl + "/scripts/jquery-1.10.2.min.js")"></script>
        <script asp-append-version="true" src="@(dashboardServiceResourceUrl + "/scripts/jquery.easing.1.3.min.js")"></script>
        <script asp-append-version="true" src="@(dashboardServiceResourceUrl + "/scripts/ej.dashboard.ejcommon.all.min.js")"></script>
        <script asp-append-version="true" src="@(dashboardServiceResourceUrl + "/scripts/ej.dashboard.viewer.all.min.js")"></script>
    }

    @{
        if (Context.User.Identity.IsAuthenticated && Context.User != null && Context.User.Identity != null && Context.User.Identity.IsAuthenticated)
        {
            enableComment = "true";
            isUserAuthenticated = "true";
        }
        else
        {
            enableComment = "false";
            isUserAuthenticated = "false";
        }
    }

    <script>
        function CommentImageDialogClose() {
            $("#commentImage_popup").ejDialog("close");
            $("#commentImage_popup_image").attr('src', "");
        }
    </script>
</head>

<body style="width: 100%; height: 100%;">
    if (Context.User.Identity.IsAuthenticated && Context.User != null && Context.User.Identity != null && Context.User.Identity.IsAuthenticated)
    <div id="widget" style="width: 100%; height: 100%;"></div>

    @if (isMobile)
    {
        <script>
            $(document)
                .ready(function () {
                    if (enableComment == "false") {
                        $("#comment-li").addClass("displayNone");
                    }
                    else {
                        $("#comment-li").removeClass("displayNone");
                    }
                });
        </script>
        <nav id="server-mobile-navbar" class="navbar navbar-inverse">
            <div class="container-fluid">
                <ul class="nav navbar-nav col-xs-12 no-padding no-margin">
                    <li class="col-xs-4">
                        <a href="@Url.Action("Widgets", "Widgets")" class="su su-nav-home" onclick="loadPopup();"></a>
                    </li>
                    <li class="col-xs-4">
                        <a href="javascript:void(0)" class="su su-nav-widgets active"></a>
                    </li>
                    <li class="col-xs-4" id="comment-li">
                        @if (ViewBag.isWidgetCommented == "true")
                        {
                            <a href="javascript:void(0)" class="su su-with-comment server-comment"></a>
                        }
                        else
                        {
                            <a href="javascript:void(0)" class="su su-without-comment server-comment"></a>
                        }
                    </li>
                </ul>
            </div>
        </nav>
    }

    <input id="comment_Type" type="hidden" data-item-type="individual-widget">
    <input id="isMultiDashboard" type="hidden" data-item-id="false">
    <input id="widget_Comment" class="displayNone" data-item-id="@ViewBag.ItemId" data-item-name="@ViewBag.itemDetail.Name">
    <input id="dashboard_Comment" class="displayNone" data-item-id="@Guid.Empty">
    <input id="is_mobile" type="hidden" value="@isMobile.ToString().ToLower()">
    <div id="commentModuleContainer" class="displayNone" style="background-color: #fff;">
        <div class="loader-blue loader-icon" id="widget-loader-icon">
            <svg class="circular">
                <circle class="path" cx="27" cy="27" r="20" fill="none" stroke-width="4" stroke-miterlimit="10"></circle>
            </svg>
        </div>
        <iframe id="commentModuleContainer_iframe" class="comment-popup-frame" src="@Url.Action("IndividualWidgetCommentPartialView", "Comments")?itemId=@ViewBag.ItemId" style="height: 100%; width: 100%; "></iframe>
    </div>

    <div id="commentImage_popup" class="col-md-12 no-padding hidden">
        <div class="col-lg-12 no-padding" id="PopupContainer">
            <div class="col-md-12">
                <div class="col-xs-12 no-padding" style="float:right">
                    <a href="javascript:void(0);" onclick="CommentImageDialogClose()" class="PopupClose"><span class="su su-close"></span></a>
                </div>
            </div>
            <div class="dialogBody col-xs-12 no-padding">
                <img id="commentImage_popup_image" src="" style="width: 100%;">
            </div>
        </div>
    </div>

    <div id="pin-widget-popup" class="displayNone" data-widget-id="" data-widget-name="">
        <iframe id="pin-widget-popup-iframe" class="" style="height: 100%; width: 100%;"></iframe>
    </div>
    <div id="success-alert">
        <div id="image-container">
            <div class="image-holder">
                <span class="su su-tick" alt="Success Icon"></span>
            </div>
        </div>
        <div id="message">
            <h1 id="message-header"></h1>
            <span id="message-content"></span>
        </div>
    </div>
    <div id="warning-alert">
        <div id="image-container">
            <span class="su su-warning-alt" alt="Warning Icon"></span>
        </div>
        <div id="message" class="div-close">
            <h1 id="message-header"></h1>
            <span id="message-content"></span>
        </div>
        <div class="close-div">
            <span id="close-content">[[[Close]]]</span>
        </div>
    </div>
    <div id="messageBox">
        <div class="message-header"></div>
        <div class="message-box-close"></div>
        <div class="message-content text-center"></div>
        <div class="message-box-btn-holder"></div>
    </div>

    <script>
        $(document).ready(function () {
            $("#messageBox").ejDialog({
                width: (window.innerWidth > 460) ? "450px" : (window.innerWidth - 10),
                showOnInit: false,
                allowDraggable: true,
                enableResize: false,
                height: "auto",
                showHeader: false,
                enableModal: true,
                close: "onMessageDialogClose"
            });
        });
    </script>
</body>

<script type="text/javascript">
    var token ="@accessToken";
    var isUserAuthenticated = "@isUserAuthenticated";
    var enableComment = "@enableComment";
    function IframeLoad() {
	if(window.parent.$("#item-viewer").data("ejWaitingPopup") != undefined) {
			window.parent.$("#item-viewer").ejWaitingPopup("hide");
		}
	}
    $(document).ready(function () {

		IframeLoad();
        var ReportName = "@ViewBag.ItemName";
        var ReportDescription = "@ViewBag.ItemDescription";
        var widgetId = "@ViewBag.ItemId";
        var browser = ej.browserInfo();
        $("#pin-widget-popup").ejDialog({
            width: "400px",
            height: "310px",
            showOnInit: false,
            allowDraggable: true,
            enableResize: false,
            title: "[[[Pin Item to the Homepage]]]",
            enableModal: true,
            showHeader: false
        });
        var pinWidgetWaitingPopupTemplateId = createLoader("pin-widget-popup_wrapper");
		$("#pin-widget-popup_wrapper").ejWaitingPopup({ template:$("#" + pinWidgetWaitingPopupTemplateId) });

        if (browser != null && browser.name === "msie" && parseFloat(browser.version) <= 8.0) {
            var divString = '<div style="top:20%;width:575px;margin:0px auto;position:relative;text-align:center">' +
                '<div style="padding:35px 68px 35px 68px;" class="e-dbrd-control-container">' +
                '<p style="font-size:18px;font-weight:bold">[[[Internet Explorer 8 and Internet Explorer 11 in Enterprise Mode are not supported]]]</p>' +
                '<p style="font-size:10px">[[[Please upgrade to a newer browser if you are using IE8 or turn off Enterprise Mode if you are using IE11 in Enterprise Mode.]]]</p>' +
                '<p style="text-align:left;margin-top:20px">[[[Supported Browsers:]]]</p><div class="alert-ie">' +
                '<div><span><img  src="@Url.Content("~/dashboardservice/themes/common-images/IE.png")" /></span><p>[[[Internet Explorer]]] 9+</p> </div> ' +
                '<div><span><img  src="@Url.Content("~/dashboardservice/themes/common-images/Edge.png")" /> </span><p>[[[Microsoft Edge]]]</p></div>' +
                '<div><span><img  src="@Url.Content("~/dashboardservice/themes/common-images/Firefox.png")" /></span><p>[[[Mozilla Firefox]]] 22+</p></div>' +
                '<div><span><img  src="@Url.Content("~/dashboardservice/themes/common-images/Chrome.png")" /></span><p>[[[Chrome]]] 17+</p></div>' +
                '<div><span><img  src="@Url.Content("~/dashboardservice/themes/common-images/Opera.png")" /></span><p>[[[Opera]]] 12+</p></div>' +
                '<div><span><img  src="@Url.Content("~/dashboardservice/themes/common-images/Safari.png")" /></span><p>[[[Safari]]] 5+</p></div></div></div>'
            var body = document.getElementById("widget");
            body.style.backgroundColor = "white";
            body.innerHTML = divString;
        } else {
            $("#widget").ejDashboardViewer({
                accessToken : token,
                serviceUrl: "@dashboardServiceResourceUrl",
                serverUrl: "@globalAppSettings.SystemSettings.BaseUrl",
                _enableHyperLinkOnErrorMessage: false,
                cdnFilePath: "@globalAppSettings.SystemSettings.UseCDN.ToString().ToLower()" == "true" ? "@globalAppSettings.SystemSettings.CDNLink" + "/scripts/viewer" : "",
                dashboardPath: "@ViewBag.ItemId/@ViewBag.Version",
                reportName: ReportName,
                reportDescription: ReportDescription,
                enableExport: true,
                enablePrint: false,
                localeSettings: {
                    resourcePath: "",
                    culture: "@ViewBag.Culture"
                },
                filterParameters: "@Html.Raw(ViewBag.FilterQuery)",
                onWidgetCommented: "openWidgetComment",
                onCommentDialogClosing: "closeWidgetComment",
                _itemId:"@ViewBag.ItemId",
                _isPublic : @isPublic,
                allowComment: @enableComment,
                commentSettings:{
                    isWidgetCommented: @Html.Raw(ViewBag.isWidgetCommented),
                },
                beforeWidgetIconRendered: function(event){
                    if($("#is_mobile").val() == "false"){
                        if(event.model._isPublic== false){
                            if(!event.isFilterWidget){
                                event.iconsinformation.unshift({ "classname": "su su-pin","name":"Pin Widget","datatooltip":"[[[Pin Widget]]]", "marginright": "-18px", "margintop":"4px"});
                            }
                        } else if (event.model._isPublic== true && isUserAuthenticated.toLowerCase()=="true") {
                            if(!event.isFilterWidget){
                                event.iconsinformation.unshift({ "classname": "su su-pin","name":"Pin Widget","datatooltip":"[[[Pin Widget]]]", "marginright": "-18px", "margintop":"4px"});
                            }
                        }
                    }
                },
                onMenuIconClick: function(information){
                    if(typeof(information.name)!= "undefined" && information.name.toLowerCase() == "pin widget"){
                        $("#pin-widget-popup").ejDialog("open");
                        $("#pin-widget-popup_wrapper").ejWaitingPopup("show");
                        $("#pin-widget-popup-iframe").attr("src", pinWidgetToHomepageUrl);
                        $("#pin-widget-popup").attr("data-widget-id", widgetId).attr("data-widget-name",information.headertext);
                    }
                },
                dashboardCreated : "openComments",
                resizeDashboard :"closeCommentOnResize"
            });
        }

        $(document).on("click", ".close-div", function () {
            parent.$('#warning-alert').fadeOut();
        });

        function createLoader(element) {
            var returnId = "";
            if (typeof element === "string") {
                var selector = (element.indexOf(".") === 0) ? "." : "#";
                element = (element.indexOf(".") === 0) ? element.slice(1, element.length) : (element.indexOf("#") === 0) ? element.slice(1, element.length) : element;
                returnId = element + "-loader-icon";

                if ($("#" + returnId).length == 0 && $(selector + element).length != 0) {
                    var template = $("<div class='loader-blue loader-icon' id='" + returnId + "'><svg class='circular'><circle class='path' cx='27' cy='27' r='20' fill='none' stroke-width='4' stroke-miterlimit='10'></circle></svg></div>");
                    $("body").append(template);
                }
                return returnId;
            }
            else {
                element = element.selector;
                var selector = (element.indexOf(".") === 0) ? "." : "#";
                element = element.slice(1, element.length);
                returnId = element + "-loader-icon";
                if ($("#" + returnId).length == 0 && $("#" + element).length != 0) {
                    var template = $("<div class='loader-blue loader-icon' id='" + returnId + "'><svg class='circular'><circle class='path' cx='27' cy='27' r='20' fill='none' stroke-width='4' stroke-miterlimit='10'></circle></svg></div>");
                    $("body").append(template);
                }
            }

            return returnId;
        }
    });
</script>